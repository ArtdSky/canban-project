# API Тестирование

Этот каталог содержит `.http` файлы для тестирования API через REST Client расширение для VS Code.

## Структура файлов

```
test_api_example/
├── login_and_reg/        # Аутентификация
│   ├── register.http     # Регистрация
│   ├── login.http        # Авторизация
│   └── logout.http       # Выход
├── user/                 # Пользователь
│   └── show.http         # Получить текущего пользователя
├── tasks/                # Задачи (CRUD)
│   ├── list.http         # Список задач (с фильтрацией по статусу)
│   ├── create.http       # Создание задачи
│   ├── show.http         # Просмотр задачи
│   ├── update.http       # Обновление задачи
│   └── delete.http       # Удаление задачи
└── comments/             # Комментарии (CRUD)
    ├── list_by_task.http # Список комментариев задачи
    ├── create.http       # Создание комментария
    ├── show.http         # Просмотр комментария
    ├── update.http       # Обновление комментария
    └── delete.http       # Удаление комментария
```

## Использование

1. **Установите REST Client расширение** для VS Code (если еще не установлено)

2. **Получите токен авторизации:**
   - Выполните запрос из `login_and_reg/register.http` для регистрации
   - Выполните запрос из `login_and_reg/login.http` для авторизации
   - Скопируйте `token` из ответа

3. **Установите токен:**
   - Откройте любой `.http` файл
   - Замените `@token = your-token-here` на ваш токен
   - Или установите токен глобально во всех файлах

4. **Выполните запросы:**
   - Нажмите "Send Request" над каждым запросом
   - Или используйте сочетание клавиш `Ctrl+Alt+R` (Linux/Windows) / `Cmd+Alt+R` (Mac)

## API Endpoints

### Аутентификация

#### `POST /api/register` - Регистрация
**Не требует авторизации**

**Тело запроса:**
```json
{
  "name": "Test User",
  "email": "test@example.com",
  "password": "password123",
  "password_confirmation": "password123"
}
```

**Валидация:**
- `name` - обязательное поле, не может быть пустым
- `email` - обязательное поле, должен быть валидным email, должен быть уникальным
- `password` - обязательное поле, минимальная длина (проверяется валидатором)
- `password_confirmation` - должно совпадать с `password`

**Важно:** Регистрация НЕ возвращает токен. После регистрации нужно авторизоваться через `/api/login`

#### `POST /api/login` - Авторизация
**Не требует авторизации**

**Тело запроса:**
```json
{
  "email": "test@example.com",
  "password": "password123"
}
```

**Ответ:** Возвращает объект с `token` для дальнейшей авторизации

#### `POST /api/logout` - Выход
**Требует токен в заголовке:** `Authorization: Bearer {token}`

Удаляет текущий токен пользователя.

#### `GET /api/user` - Получить текущего пользователя
**Требует токен в заголовке:** `Authorization: Bearer {token}`

Возвращает информацию о текущем авторизованном пользователе.

### Задачи

#### `GET /api/tasks` - Список задач
**Требует токен в заголовке:** `Authorization: Bearer {token}`

**Параметры запроса (query):**
- `status` (опционально) - фильтрация по статусу: `todo`, `in_progress`, `done`
  - Пример: `/api/tasks?status=todo`

Возвращает список задач, в которых пользователь является участником (creator, assignee или observer).

#### `POST /api/tasks` - Создание задачи
**Требует токен в заголовке:** `Authorization: Bearer {token}`

**Тело запроса:**
```json
{
  "title": "Новая задача",
  "description": "Описание задачи",
  "status": "todo",
  "due_date": "2025-12-31 23:59:59",
  "assignee_ids": [2, 3],
  "observer_ids": [4]
}
```

**Поля:**
- `title` - обязательное поле, не может быть пустым
- `description` - опциональное поле
- `status` - опциональное, по умолчанию `todo`. Допустимые значения: `todo`, `in_progress`, `done`
- `due_date` - опциональное, формат: `YYYY-MM-DD HH:MM:SS`
- `assignee_ids` - массив ID пользователей-исполнителей (может быть пустым)
- `observer_ids` - массив ID пользователей-наблюдателей (может быть пустым)

**Важно:** 
- При создании задачи текущий пользователь автоматически становится создателем (`creator`)
- Пользователь может указать себя в `assignee_ids`, чтобы иметь несколько ролей
- Все указанные в `assignee_ids` и `observer_ids` пользователи должны существовать

#### `GET /api/tasks/{task}` - Просмотр задачи
**Требует токен в заголовке:** `Authorization: Bearer {token}`

**Параметры пути:**
- `task` - ID задачи

Возвращает задачу только если пользователь является участником (creator, assignee или observer).

#### `PUT /api/tasks/{task}` - Обновление задачи
**Требует токен в заголовке:** `Authorization: Bearer {token}`

**Параметры пути:**
- `task` - ID задачи

**Тело запроса (все поля опциональны):**
```json
{
  "title": "Обновленное название",
  "description": "Обновленное описание",
  "status": "in_progress",
  "assignee_ids": [2, 3, 5],
  "observer_ids": [4, 6, 7]
}
```

Можно обновлять поля по отдельности или все вместе. Списки исполнителей и наблюдателей можно обновлять независимо друг от друга.

#### `DELETE /api/tasks/{task}` - Удаление задачи
**Требует токен в заголовке:** `Authorization: Bearer {token}`

**Параметры пути:**
- `task` - ID задачи

Удаление доступно только создателю задачи или пользователю с соответствующими правами.

### Комментарии

#### `GET /api/tasks/{task}/comments` - Список комментариев задачи
**Требует токен в заголовке:** `Authorization: Bearer {token}`

**Параметры пути:**
- `task` - ID задачи

Возвращает список комментариев к задаче. Доступно только если пользователь является участником задачи.

#### `POST /api/tasks/{task}/comments` - Создание комментария
**Требует токен в заголовке:** `Authorization: Bearer {token}`

**Параметры пути:**
- `task` - ID задачи

**Тело запроса:**
```json
{
  "content": "Это комментарий к задаче",
  "status": "visible"
}
```

**Поля:**
- `content` - обязательное поле, не может быть пустым
- `status` - опциональное, по умолчанию `visible`. Допустимые значения: `visible`, `hidden`

Доступно только если пользователь является участником задачи.

#### `GET /api/comments/{comment}` - Просмотр комментария
**Требует токен в заголовке:** `Authorization: Bearer {token}`

**Параметры пути:**
- `comment` - ID комментария

Возвращает комментарий только если пользователь имеет доступ к задаче, к которой относится комментарий.

#### `PUT /api/comments/{comment}` - Обновление комментария
**Требует токен в заголовке:** `Authorization: Bearer {token}`

**Параметры пути:**
- `comment` - ID комментария

**Тело запроса (все поля опциональны):**
```json
{
  "content": "Обновленное содержание комментария",
  "status": "hidden"
}
```

**Важно:** Комментарии можно редактировать только свои (только создатель комментария).

#### `DELETE /api/comments/{comment}` - Удаление комментария (скрытие)
**Требует токен в заголовке:** `Authorization: Bearer {token}`

**Параметры пути:**
- `comment` - ID комментария

**Важно:** 
- Комментарии не удаляются физически, а скрываются (status = hidden)
- Удалять (скрывать) можно только свои комментарии
- Комментарий можно восстановить, изменив статус обратно на `visible` через `PUT /api/comments/{comment}`

## Важные замечания

1. **Регистрация не возвращает токен** - после регистрации нужно авторизоваться через `/api/login`

2. **Доступ к задачам и комментариям:**
   - Пользователь может видеть/редактировать только те задачи, в которых он является участником
   - Участники задачи определяются через таблицу `task_participants` с ролями: `creator`, `assignee`, `observer`
   - Один пользователь может иметь несколько ролей в одной задаче (например, быть создателем и исполнителем одновременно)
   - Комментарии доступны только к задачам, к которым у пользователя есть доступ

3. **Создание и обновление задач:**
   - При создании задачи пользователь автоматически становится создателем (`creator`)
   - Исполнители указываются в массиве `assignee_ids` (может быть несколько)
   - Наблюдатели указываются в массиве `observer_ids` (может быть несколько)
   - Пример: `{"title": "...", "assignee_ids": [2, 3], "observer_ids": [4]}`
   - При обновлении можно обновить списки исполнителей и/или наблюдателей отдельно
   - Можно очистить списки, передав пустой массив: `{"assignee_ids": []}`

4. **Статусы задач (State Machine):**
   - `todo` → `in_progress` или `done` (прямой переход разрешен)
   - `in_progress` → `todo` или `done`
   - `done` → `in_progress` (можно вернуться в работу)
   - Переход `done` → `todo` не допускается

5. **Статусы комментариев (State Machine):**
   - `visible` → `hidden` (скрытие)
   - `hidden` → `visible` (восстановление)

6. **Права доступа к комментариям:**
   - Комментарии можно редактировать только свои (только создатель комментария)
   - Комментарии можно удалять (скрывать) только свои
   - Просматривать комментарии могут все участники задачи

7. **Валидация:**
   - Все обязательные поля проверяются на наличие и корректность
   - Email должен быть уникальным при регистрации
   - Пароли должны совпадать (`password` и `password_confirmation`)
   - Статусы проверяются на допустимые значения
   - ID пользователей в `assignee_ids` и `observer_ids` должны существовать

## Переменные

В каждом файле используются переменные:
- `@baseUrl = http://localhost:8080` - базовый URL API
- `@token = your-token-here` - токен авторизации (замените на ваш)
- `@taskId = 1` - ID задачи (в файлах задач и комментариев)
- `@commentId = 1` - ID комментария (в файлах комментариев)

Для удобства можно создать общий файл с переменными, но в данном проекте переменные определены в каждом файле для независимости.

## Примеры использования

### Полный цикл работы с API:

1. **Регистрация:**
   ```http
   POST http://localhost:8080/api/register
   Content-Type: application/json
   
   {
     "name": "Test User",
     "email": "test@example.com",
     "password": "password123",
     "password_confirmation": "password123"
   }
   ```

2. **Авторизация (получение токена):**
   ```http
   POST http://localhost:8080/api/login
   Content-Type: application/json
   
   {
     "email": "test@example.com",
     "password": "password123"
   }
   ```

3. **Создание задачи:**
   ```http
   POST http://localhost:8080/api/tasks
   Authorization: Bearer {ваш_токен}
   Content-Type: application/json
   
   {
     "title": "Моя первая задача",
     "description": "Описание",
     "assignee_ids": [2],
     "observer_ids": [3]
   }
   ```

4. **Добавление комментария:**
   ```http
   POST http://localhost:8080/api/tasks/1/comments
   Authorization: Bearer {ваш_токен}
   Content-Type: application/json
   
   {
     "content": "Это мой комментарий"
   }
   ```
